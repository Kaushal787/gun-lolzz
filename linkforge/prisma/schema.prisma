generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum DeviceType {
  mobile
  desktop
  tablet
  unknown
}

enum ProfileLayout {
  stacked
  centered
  grid
}

enum BlockType {
  links
  text
  embed
  faq
  support
  email_capture
}

enum FilePrivacy {
  public
  unlisted
  private
}

enum ReportTargetType {
  profile
  file
  user
}

enum ReportStatus {
  open
  resolved
  dismissed
}

enum ThemeKey {
  dark
  light
  gradient_neon
  minimal
}

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  passwordHash  String?
  username      String   @unique
  displayName   String
  bio           String?  @db.Text
  avatarUrl     String?
  isAdmin       Boolean  @default(false)
  isSuspended   Boolean  @default(false)
  apiKey        String   @unique @default(uuid())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  profiles      Profile[]
  files         FileAsset[]
  badges        UserBadge[]
  followers     Follower[]         @relation("followers")
  following     Follower[]         @relation("following")
  auditLogs     AuditLog[]
  reports       Report[]           @relation("reportsByUser")
  grantedBadges UserBadge[]        @relation("grantedBy")
  passwordResets PasswordResetToken[]

  accounts      Account[]
  sessions      Session[]
}

model Profile {
  id               String        @id @default(cuid())
  userId           String
  slug             String        @unique
  title            String
  description      String?
  themeKey         ThemeKey      @default(dark)
  layout           ProfileLayout @default(stacked)
  showViewCounter  Boolean       @default(true)
  totalViews       Int           @default(0)
  isDiscoverable   Boolean       @default(true)
  tags             String[]
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  user             User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  blocks           ProfileBlock[]
  links            Link[]
  viewEvents       ViewEvent[]
  clickEvents      ClickEvent[]
  subscribers      EmailSubscriber[]

  @@index([userId])
  @@index([isDiscoverable])
}

model ProfileBlock {
  id          String    @id @default(cuid())
  profileId   String
  type        BlockType
  title       String?
  contentJson Json
  order       Int       @default(0)
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  profile     Profile   @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId, order])
}

model Link {
  id         String    @id @default(cuid())
  profileId  String
  label      String
  url        String
  icon       String?
  order      Int       @default(0)
  isActive   Boolean   @default(true)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  profile    Profile   @relation(fields: [profileId], references: [id], onDelete: Cascade)
  clickEvents ClickEvent[]

  @@index([profileId, order])
}

model Badge {
  id          String   @id @default(cuid())
  key         String   @unique
  label       String
  description String?
  isSystem    Boolean  @default(false)
  priceCents  Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  owners      UserBadge[]
}

model UserBadge {
  id               String   @id @default(cuid())
  userId           String
  badgeId          String
  customText       String?
  grantedByUserId  String?
  createdAt        DateTime @default(now())

  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge            Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)
  grantedBy        User?    @relation("grantedBy", fields: [grantedByUserId], references: [id])

  @@unique([userId, badgeId])
}

model FileAsset {
  id               String     @id @default(cuid())
  userId           String
  originalFilename String
  mimeType         String
  sizeBytes        Int
  storageKey       String
  publicUrl        String
  thumbUrl         String?
  privacy          FilePrivacy @default(unlisted)
  tags             String[]
  isDeleted        Boolean    @default(false)
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt

  user             User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, privacy])
}

model ViewEvent {
  id               String     @id @default(cuid())
  profileId        String
  createdAt        DateTime   @default(now())
  country          String?
  deviceType       DeviceType @default(unknown)
  referrer         String?
  viewerSessionId  String

  profile          Profile    @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId, createdAt])
  @@index([viewerSessionId])
}

model ClickEvent {
  id         String     @id @default(cuid())
  profileId  String
  linkId     String
  createdAt  DateTime   @default(now())
  country    String?
  deviceType DeviceType @default(unknown)
  referrer   String?

  profile    Profile    @relation(fields: [profileId], references: [id], onDelete: Cascade)
  link       Link       @relation(fields: [linkId], references: [id], onDelete: Cascade)

  @@index([profileId, createdAt])
  @@index([linkId])
}

model Follower {
  id               String   @id @default(cuid())
  followerUserId   String
  followingUserId  String
  createdAt        DateTime @default(now())

  follower         User     @relation("followers", fields: [followerUserId], references: [id], onDelete: Cascade)
  following        User     @relation("following", fields: [followingUserId], references: [id], onDelete: Cascade)

  @@unique([followerUserId, followingUserId])
  @@index([followingUserId])
}

model EmailSubscriber {
  id         String   @id @default(cuid())
  profileId  String
  email      String
  source     String
  createdAt  DateTime @default(now())

  profile    Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
}

model Report {
  id               String           @id @default(cuid())
  reporterUserId   String?
  targetType       ReportTargetType
  targetId         String
  reason           String           @db.Text
  status           ReportStatus     @default(open)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  reporter         User?            @relation("reportsByUser", fields: [reporterUserId], references: [id])
}

model AuditLog {
  id           String    @id @default(cuid())
  userId       String?
  action       String
  metadataJson Json?
  createdAt    DateTime  @default(now())

  user         User?     @relation(fields: [userId], references: [id])
}

/* NextAuth Prisma Adapter models */
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String

  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

